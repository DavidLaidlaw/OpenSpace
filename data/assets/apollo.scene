--apollo.scene (recreates the apollo 8 and 15 missions from available spice data)

--Apollo 8 only has spk/position kernel
--Apollo 15 only has moon orbits but does contain pointing kernel

-- All moon layers can be downloaded from openspaceproject.com or directly here:
-- https://drive.google.com/file/d/19qIXS4TcHkSFp8lauPG7I64Xj2J3flbG/view
-- Except for the 38BG Apollo metric cam image which can be obtained here: 
-- https://moontrek.jpl.nasa.gov/TrekWS/rest/cat/data/stream?label=Apollo15_MetricCam_Mosaic_Global_4096ppd
-- vrt and .info files for the metric cam can be found here: https://drive.google.com/file/d/1_9TcjxhepMd0bOxMS4jGteyCYLJ7dRj5/view


local assetHelper = asset.require('util/asset_helper')
local sceneHelper = asset.require('util/scene_helper')
local propertyHelper = asset.require('util/property_helper')

asset.require('spice/base')
assetHelper.requestAll(asset, 'scene/solarsystem/sun')
asset.require('scene/solarsystem/planets')
asset.request('scene/digitaluniverse/stars')
asset.request('scene/digitaluniverse/milkyway')

asset.require('util/default_keybindings')
asset.require('util/default_dashboard')

asset.request('customization/globebrowsing')

local a15Asset = asset.require('scene/solarsystem/missions/apollo/a15')
local a8Asset = asset.require('scene/solarsystem/missions/apollo/a8')

-- Custom Keybindings
-- Key bindings are set up for each landing site.
-- These custom key bindings are expecting moon map layers to be downloaded and added via the customization/globebrowsing asset.

local Keybindings = {
    {
        Key = "F4",
        Command = "openspace.setPropertyValue('Scene.Moon.RenderableGlobe.Layers.ColorLayers.LRO_NAC_Apollo*.Enabled', false);" ..
                  "openspace.setPropertyValue('Scene.Moon.RenderableGlobe.Layers.HeightLayers.LRO_NAC_Apollo*.Enabled', false);" ..
                  "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.HeightLayers.LRO_NAC_Apollo_14.Enabled', true);" ..
                  "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.ColorLayers.LRO_NAC_Apollo_14.Enabled', true);",
        Documentation = "Shows Apollo 15 NAC landing site and hides all others",
        Local = false
    },
    {
    	Key = "F5",
        Command =   "openspace.setPropertyValue('Scene.Moon.RenderableGlobe.Layers.ColorLayers.LRO_NAC_Apollo*.Enabled', false);" ..
                    "openspace.setPropertyValue('Scene.Moon.RenderableGlobe.Layers.HeightLayers.LRO_NAC_Apollo*.Enabled', false);" ..
                    "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.HeightLayers.LRO_NAC_Apollo15_DEM_180.Enabled', true);" ..
                    "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.ColorLayers.Apollo_15_LRO_NAC_Mosaic.Enabled', true); " ..
                    "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.ColorLayers.Apollo_15_LRO_NAC_Mosaic.Settings.Gamma', 1.2);" ..
                    "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.ColorLayers.Apollo_15_LRO_NAC_Mosaic.Settings.Multiplier', 2.0);" ..
                    "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.HeightLayers.LRO_NAC_Apollo_15.Enabled', true);" ..
                    "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.ColorLayers.LRO_NAC_Apollo_15.Enabled', true);" ..
                    "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.ColorLayers.LRO_NAC_Apollo_15.Settings.Gamma', 1.0);" ..
                    "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.ColorLayers.LRO_NAC_Apollo_15.Settings.Multiplier', 1.3);", 

        Documentation = "Shows Apollo 15 NAC landing site and hides all others",
        Local = false
    },
    {
    	Key = "F6",
        Command = "openspace.setPropertyValue('Scene.Moon.RenderableGlobe.Layers.ColorLayers.LRO_NAC_Apollo*.Enabled', false);" ..
                  "openspace.setPropertyValue('Scene.Moon.RenderableGlobe.Layers.HeightLayers.LRO_NAC_Apollo*.Enabled', false);" ..
         		  "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.HeightLayers.LRO_NAC_Apollo_16.Enabled', true);" ..
                  "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.ColorLayers.LRO_NAC_Apollo_16.Enabled', true);",
        Documentation = "Shows Apollo 16 NAC landing site and hides all others",
        Local = false
    },
    {
    	Key = "F7",
        Command = "openspace.setPropertyValue('Scene.Moon.RenderableGlobe.Layers.ColorLayers.LRO_NAC_Apollo*.Enabled', false);" ..
                  "openspace.setPropertyValue('Scene.Moon.RenderableGlobe.Layers.HeightLayers.LRO_NAC_Apollo*.Enabled', false);" ..
         		  "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.HeightLayers.LRO_NAC_Apollo_17.Enabled', true);" ..
                  "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.ColorLayers.LRO_NAC_Apollo_17.Enabled', true);",
        Documentation = "Shows Apollo 16 NAC landing site and hides all others",
        Local = false
    },
      {
        Key = "F11",
        Command =   "openspace.setPropertyValue('Scene.Moon.RenderableGlobe.Layers.ColorLayers.LRO_NAC_Apollo*.Enabled', false);" ..
                    "openspace.setPropertyValue('Scene.Moon.RenderableGlobe.Layers.HeightLayers.LRO_NAC_Apollo*.Enabled', false);" ..
                    "openspace.asset.add('scene/solarsystem/missions/apollo/slides-apollo11');\n" ..
                    "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.HeightLayers.LRO_NAC_Apollo_11.Enabled', true);" ..
                    "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.ColorLayers.LRO_NAC_Apollo_11.Enabled', true);",
        Documentation = "Shows Apollo 15 NAC landing site and hides all others",
        Local = false
    },
    {
        Key = "F12",
        Command = "openspace.setPropertyValue('Scene.Moon.RenderableGlobe.Layers.ColorLayers.LRO_NAC_Apollo*.Enabled', false);" ..
                  "openspace.setPropertyValue('Scene.Moon.RenderableGlobe.Layers.HeightLayers.LRO_NAC_Apollo*.Enabled', false);" ..
                  "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.HeightLayers.LRO_NAC_Apollo_12.Enabled', true);" ..
                  "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.ColorLayers.LRO_NAC_Apollo_12.Enabled', true);",
        Documentation = "Shows Apollo 15 NAC landing site and hides all others",
        Local = false
    },
    {
        Key = "F9",
        Command =   "openspace.setPropertyValue('Scene.Moon.RenderableGlobe.Layers.ColorLayers.LRO_NAC_Apollo*.Enabled', false);" ..
                    "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.ColorLayers.Apollo_15_LRO_NAC_Mosaic.Enabled', false);" ..
                  "openspace.setPropertyValue('Scene.Moon.RenderableGlobe.Layers.HeightLayers.LRO_NAC_Apollo*.Enabled', false);",
        Documentation = "Hide all Apollo NAC landing sites",
        Local = false
    },
    {
        Key = "U",
        Command =   "openspace.time.setTime('1968-12-21T15:50:00.00')" ..
                    "openspace.setPropertyValueSingle('Scene.Apollo8Trail.renderable.Enabled', true);" ..
                    "openspace.setPropertyValueSingle('Scene.Apollo15.Rotation.SourceFrame', [[GALACTIC]]);",

        Documentation = "Jump to time right before A8 liftoff",
        Local = false
    },
    {
        Key = "I",
        Command =   "openspace.time.setTime('1971-07-30T02:22:00.00');" ..
                    "openspace.setPropertyValueSingle('Scene.Apollo15.Rotation.SourceFrame', [[A15_METRIC]]);",
        Documentation = "Jump to time right before A8 liftoff",
        Local = false
    },
    {
        Key = "O",
        Command = "openspace.time.setTime('1971-08-01T01:51:01.00');" ..
                  "openspace.setPropertyValueSingle('Scene.Apollo15.Rotation.SourceFrame', [[A15_METRIC]]);" ..
                  "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.ColorLayers.Apollo_15_Metric_Cam_Fix1.Settings.Gamma', 1.906);" ..
                  "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.ColorLayers.Apollo_15_Metric_Cam_Fix1.Settings.Multiplier', 1.87);",
        Documentation = "Jump to a when the A15 craft is over the A15 site (with lighting adjustments to compensate for shading)",
        Local = false
    },
    {
        Key = "P",
        Command = "openspace.time.setTime('1971-08-01T05:38:29.00');" ..
                  "openspace.setPropertyValueSingle('Scene.Apollo15.Rotation.SourceFrame', [[A15_METRIC]]);" ..
                  "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.ColorLayers.Apollo_15_Metric_Cam_Fix1.Settings.Gamma', 2.535);" ..
                  "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.ColorLayers.Apollo_15_Metric_Cam_Fix1.Settings.Multiplier', 1.12);",
        Documentation = "Jump to a when the A15 craft is over the A17 site (with lighting adjustments to compensate for shading)",
        Local = false
    },
    {
        Key = "M",
        Command = propertyHelper.invert('Scene.Moon.RenderableGlobe.Layers.ColorLayers.Apollo_15_Metric_Cam_Fix1.Enabled'),
        Documentation = "Toggles Apollo 15 Metric Cam",
        Local = false
    },
    {
        Key = "K",
        Command = propertyHelper.invert('Scene.Moon.RenderableGlobe.Layers.ColorLayers.Kaguya_Utah.Enabled'),
        Documentation = "Toggles Moon Kaguya color layer",
        Local = false
    },
    {
        Key = "N",
        Command = "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.ColorLayers.Apollo_15_Metric_Cam_Fix1.Settings.Gamma', 2.535210);" ..
                  "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.ColorLayers.Apollo_15_Metric_Cam_Fix1.Settings.Multiplier', 1.126760);",
        Documentation = "Adjusts 'lighting' of Apollo 15 Metric Cam",
        Local = false
    },
    {
        Key = "B",
        Command = "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.ColorLayers.Apollo_15_Metric_Cam_Fix1.Settings.Gamma', 1.5);" ..
                  "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.ColorLayers.Apollo_15_Metric_Cam_Fix1.Settings.Multiplier', 1.0);",
        Documentation = "Adjusts 'lighting' of Apollo 15 Metric Cam",
        Local = false
    },
    {
        Key = "G",
        Command = propertyHelper.invert('Scene.Moon.RenderableGlobe.Layers.ColorLayers.Kaguya_LGM2011_FreeairGravity_Colorized_Global_mgal3m_20ppd.Enabled') ..
                  "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.ColorLayers.Kaguya_LGM2011_FreeairGravity_Colorized_Global_mgal3m_20ppd.Settings.Gamma', 1.73);" ..
                  "openspace.setPropertyValueSingle('Scene.Moon.RenderableGlobe.Layers.ColorLayers.Kaguya_LGM2011_FreeairGravity_Colorized_Global_mgal3m_20ppd.Settings.Multiplier', 1.22);",
        Documentation = "Shows Moon Gravity Texture and sets lighting paramaters for AMNH dome",
        Local = false
    },
    {
        Key = "R",
        Command = propertyHelper.invert('Scene.Apollo15Trail.renderable.Enabled'),
        Documentation = "Toggles the trails of the Apollo15 orbits",
        Local = false
    },
    {
        Key = "T",
        Command = propertyHelper.invert('Scene.Apollo8Trail.renderable.Enabled'),
        Documentation = "Toggles the trails of the Apollo8 orbits",
        Local = false
    },
    {
        Key = "H",
        Command = "openspace.setPropertyValue('Scene.*Trail.renderable.Enabled', false)",
        Documentation = "Disables visibility of all trails",
        Local = false
    },
    {
        Key = "J",
        Command =   "openspace.setPropertyValue('Scene.*Trail.renderable.Enabled', true)" ..
                    "openspace.setPropertyValue('Scene.Apollo8Trail.renderable.Enabled', false)" ..
                    "openspace.setPropertyValue('Scene.Apollo15Trail.renderable.Enabled', false)",
        Documentation = "Enables visibility of all trails (except for apollo craft)",
        Local = false
    },
    {
        Key = "A",
        Command = propertyHelper.invert('Scene.Moon.RenderableGlobe.UseAccurateNormals'),
        Documentation = "Toggles use acurate normals for the moon",
        Local = false
    },
    {
        Key = "S",
        Command = propertyHelper.invert('Scene.Moon.RenderableGlobe.PerformShading'),
        Documentation = "Toggles PerformShading for the moon",
        Local = false
    },
    {
        Key = "PAGE_UP",
        Command = "openspace.setPropertyValue('NavigationHandler.Origin', 'Apollo15');",
        Documentation = "Set's focus on apollo15",
        Local = false
    },
    {
        Key = "PAGE_DOWN",
        Command = "openspace.setPropertyValue('NavigationHandler.Origin', 'Moon');",
        Documentation = "Set's focus on the Moon",
        Local = false
    },
    {
        Key = "HOME",
        Command = "openspace.setPropertyValue('NavigationHandler.Origin', 'Earth');",
        Documentation = "Set's focus on the Earth",
        Local = false
    }

}
asset.onInitialize(function ()
    openspace.time.setTime("1968-12-21T11:50:00.00")

    openspace.clearKey("F4")
    openspace.clearKey("F12")
    openspace.clearKey("F12")
    sceneHelper.bindKeys(Keybindings)

    openspace.setDefaultGuiSorting()

    sceneHelper.setDeltaTimeKeys({
      1, 5, 10, 20, 40, 90, 360, 720, 2880, 14400,
      28800, 57600, 115200, 230400, 460800, 921600, 1843200, 3686400, 7372800, 14745600
    })

    openspace.markInterestingNodes({
        "Earth", "Moon", "Apollo15", "Apollo8CSM"
    })

    openspace.addVirtualProperty(
        "BoolProperty",
        "Show Trails",
        "*Trail.renderable.Enabled",
        "Disable or enable all trails of the scene at the same time",
        true,
        nil,
        nil
    )

    openspace.navigation.setCameraState({
        Focus = "Earth",
        Position = {-146300361377.021454, -16569225220.310442, 266702346.800725},
        Rotation = {-0.867741, -0.182677, 0.444231, 0.127721},
    })

    openspace.globebrowsing.goToGeo(58.5877, 16.1924, 20000000)

end)

asset.onDeinitialize(function ()
    openspace.removeVirtualProperty("*Trail.renderable.Enabled")

    openspace.removeInterestingNodes({
        "Earth", "Moon", "Apollo15", "Apollo8CSM"
    })
end)
